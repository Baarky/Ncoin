<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>送金ページ</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 30px;
    }
    #reader {
      width: 300px;
      margin: 0 auto;
    }
    input, button {
      margin: 10px;
      padding: 8px;
    }
  </style>
</head>
<body>
  <h2>QRコード送金</h2>
  <p>送金相手: <span id="recipient">（未選択）</span></p>
  <div id="reader"></div>

  <div>
    <input type="number" id="amount" placeholder="送金額を入力" min="1">
    <button id="sendBtn" disabled>送金する</button>
  </div>

  <script>
    const html5QrCode = new Html5Qrcode("reader");
    let recipientNickname = null;

    // --- 送金元情報取得 ---
    const urlParams = new URLSearchParams(window.location.search);
    let senderNickname = urlParams.get("from") || localStorage.getItem("nickname");
    if (!senderNickname) {
      alert("送金元情報が見つかりません。ログインしてください。");
      location.href = "/login.html";
    }

    // --- 外カメラ優先でQRスキャン ---
    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length) {
        // 外カメラがあれば優先、なければ最初のカメラ
        const backCamera = cameras.find(cam => /back|rear|外/.test(cam.label.toLowerCase()));
        const cameraId = backCamera ? backCamera.id : cameras[0].id;

        html5QrCode.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            try {
              const url = new URL(decodedText);
              const fromParam = url.searchParams.get("from");
              if (fromParam) {
                recipientNickname = fromParam;
                document.getElementById("recipient").textContent = recipientNickname;
                document.getElementById("sendBtn").disabled = false;
                html5QrCode.stop();
              } else {
                alert("QRコードに送信者情報が含まれていません。");
              }
            } catch {
              alert("無効なQRコードです。");
            }
          },
          (errorMessage) => { /* スキャン失敗時は無視 */ }
        );
      } else {
        alert("カメラが見つかりません。");
      }
    }).catch(err => {
      alert("カメラのアクセスに失敗しました: " + err);
    });

    // --- 送金ボタン ---
    document.getElementById("sendBtn").addEventListener("click", async () => {
      const amount = parseInt(document.getElementById("amount").value);
      if (!recipientNickname || !amount) {
        alert("送金先と金額を確認してください。");
        return;
      }

      const res = await fetch("/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from: senderNickname, to: recipientNickname, amount })
      });

      const data = await res.json();
      if (data.error) alert(data.error);
      else alert(`送金成功: 残高 ${data.balance} コイン`);

      if (res.ok) location.href = "/dashboard.html";
    });
  </script>
</body>
</html>
