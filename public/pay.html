<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QRコード送金</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 30px;
    }
    #reader {
      width: 300px;
      margin: 0 auto;
    }
    input, button {
      margin: 10px;
      padding: 8px;
    }
  </style>
</head>
<body>
  <h2>QRコード送金</h2>
  <p>送金相手: <span id="recipient">（未選択）</span></p>

  <div>
    <button id="frontBtn">内カメラ</button>
    <button id="backBtn">外カメラ</button>
  </div>

  <div id="reader"></div>

  <div>
    <input type="number" id="amount" placeholder="送金額を入力" min="1">
    <button id="sendBtn" disabled>送金する</button>
  </div>

  <script>
    const html5QrCode = new Html5Qrcode("reader");
    let recipientNickname = null;
    let cameras = [];
    let currentCameraId = null;

    async function initCameras() {
      try {
        cameras = await Html5Qrcode.getCameras();
        if (cameras.length === 0) {
          alert("カメラが見つかりません。");
        }
      } catch (err) {
        alert("カメラの取得に失敗しました: " + err);
      }
    }

    async function startCamera(cameraId) {
      if (currentCameraId) {
        await html5QrCode.stop().catch(() => {});
      }
      currentCameraId = cameraId;
      html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          try {
            const url = new URL(decodedText);
            const fromParam = url.searchParams.get("from");
            if (fromParam) {
              recipientNickname = fromParam;
              document.getElementById("recipient").textContent = recipientNickname;
              document.getElementById("sendBtn").disabled = false;
              html5QrCode.stop();
            } else {
              alert("QRコードに送信者情報が含まれていません。");
            }
          } catch {
            alert("無効なQRコードです。");
          }
        },
        (errorMessage) => { /* スキャン失敗時は無視 */ }
      );
    }

    document.getElementById("frontBtn").addEventListener("click", async () => {
      const front = cameras.find(cam => cam.label.toLowerCase().includes("front")) || cameras[0];
      if (front) startCamera(front.id);
      else alert("内カメラが見つかりません。");
    });

    document.getElementById("backBtn").addEventListener("click", async () => {
      const back = cameras.find(cam =>
        cam.label.toLowerCase().includes("back") ||
        cam.label.toLowerCase().includes("rear") ||
        cam.label.toLowerCase().includes("environment")
      ) || cameras[cameras.length - 1];
      if (back) startCamera(back.id);
      else alert("外カメラが見つかりません。");
    });

    // 初期化
    initCameras();

    // ✅ 送金処理
    document.getElementById("sendBtn").addEventListener("click", async () => {
      const amount = parseInt(document.getElementById("amount").value);
      const urlParams = new URLSearchParams(window.location.search);
      const senderNickname = urlParams.get("from");

      if (!senderNickname) {
        alert("送金元情報が見つかりません。ダッシュボードからアクセスしてください。");
        return;
      }

      if (!recipientNickname || !amount) {
        alert("送金先と金額を確認してください。");
        return;
      }

      const res = await fetch("/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from: senderNickname, to: recipientNickname, amount })
      });

      const data = await res.json();
      alert(data.message);
      if (res.ok) location.href = "/dashboard.html?nickname=" + encodeURIComponent(senderNickname);
    });
  </script>
</body>
</html>
