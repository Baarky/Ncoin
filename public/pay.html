<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>QR送金</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <h1>QRコードで送金</h1>
  <div id="reader" style="width:300px;"></div>

  <h3>送金先: <span id="recipient">なし</span></h3>
  <input type="number" id="amount" placeholder="送金額">
  <button id="sendBtn" disabled>送金</button>

  <script>
    const nickname = localStorage.getItem("nickname");
    if (!nickname) {
      alert("ログイン情報がありません");
      location.href = "/login.html";
    }

    let recipientNickname = "";

    // QRコード読み取り
    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            recipientNickname = decodedText.trim();
            document.getElementById("recipient").textContent = recipientNickname;
            document.getElementById("sendBtn").disabled = false;
            html5QrCode.stop();
          },
          (error) => { /* 読み取り失敗は無視 */ }
        );
      }
    }).catch(console.error);

    // 送金ボタン
    document.getElementById("sendBtn").addEventListener("click", async () => {
      const amount = Number(document.getElementById("amount").value);
      if (!recipientNickname) return alert("QRを読み取ってください");
      if (!amount || amount <= 0) return alert("送金額を入力してください");

      const res = await fetch("/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from: nickname, to: recipientNickname, amount })
      });

      const data = await res.json();
      if (data.error) alert(data.error);
      else {
        alert(`送金成功! 残高: ${data.balance}`);
        location.href = "/dashboard"; // 送金後はダッシュボードに戻る
      }
    });
  </script>
</body>
</html>
