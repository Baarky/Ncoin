<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
</head>
<body>
  <h1 id="welcome"></h1>
  <h2>残高: <span id="balance">0</span> コイン</h2>

  <h2>クエスト報酬</h2>
  <input type="number" id="questAmount" placeholder="獲得コイン">
  <button id="questBtn">報酬を獲得</button>
  <h2>送金</h2>
  <input type="text" id="sendTo" placeholder="送金先ニックネーム">
  <input type="number" id="sendAmount" placeholder="送金額">
  <button id="sendBtn">送金する</button>

  <h2>ランキング</h2>
  <ol id="rankingList"></ol>

  <h2>送金履歴 / クエスト履歴</h2>
  <ul id="historyList"></ul>

  <script>
    let nickname = localStorage.getItem("nickname");
    if (!nickname) {
      alert("ログイン情報がありません");
      location.href = "/login.html";
    }

    document.getElementById("welcome").textContent = `ようこそ ${nickname} さん`;

    const balanceEl = document.getElementById("balance");
    const rankingEl = document.getElementById("rankingList");
    const historyEl = document.getElementById("historyList");

    async function fetchBalance() {
      const res = await fetch(`/balance/${nickname}`);
      const data = await res.json();
      balanceEl.textContent = data.balance;
    }

    document.getElementById("questBtn").addEventListener("click", async () => {
      const amount = Number(document.getElementById("questAmount").value);
      if (!amount) return;
      const res = await fetch("/quest", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nickname, amount })
      });
      const data = await res.json();
      balanceEl.textContent = data.balance;
      fetchHistory();
      fetchRanking();
    });

    async function fetchRanking() {
      const res = await fetch("/ranking");
      const ranking = await res.json();
      rankingEl.innerHTML = "";
      ranking.forEach(u => {
        const li = document.createElement("li");
        li.textContent = `${u.nickname}: ${u.balance} コイン`;
        rankingEl.appendChild(li);
      });
    }

    async function fetchHistory() {
      const res = await fetch(`/history/${nickname}`);
      const history = await res.json();
      historyEl.innerHTML = "";
      history.forEach(h => {
        const li = document.createElement("li");
        let text = `[${h.date.split("T")[0]}] `;
        if (h.type === "クエスト報酬") text += `クエスト報酬: +${h.amount}`;
        li.textContent = text;
        historyEl.appendChild(li);
      });
    }

    fetchBalance();
    fetchRanking();
    fetchHistory();
  </script>
  <script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

// 既存の fetchBalance, fetchRanking, fetchHistory を使用

// WebSocketで他ユーザの更新を反映
socket.on("update", ({ nickname: updatedUser, db }) => {
  fetchBalance();  // 自分の残高を再取得
  fetchRanking();
  fetchHistory();
});
</script>

</body>
</html>
