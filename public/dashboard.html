<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ncoin Dashboard</title>
<style>
body { font-family: sans-serif; background: #eef1f5; margin: 0; padding: 2rem; }
.card { background: #fff; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 2rem; margin-bottom: 2rem; width: 350px; }
input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-top: 10px; }
button { margin-top: 10px; padding: 10px 20px; border: none; border-radius: 8px; background-color: #007bff; color: #fff; cursor: pointer; }
button:hover { background-color: #0069d9; }
.logout { background-color: #dc3545; }
.logout:hover { background-color: #c82333; }
h3 { margin-top: 1rem; margin-bottom: 0.5rem; }
#qr { width: 200px; height: 200px; margin-top: 10px; display: none; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
td, th { border: 1px solid #ccc; padding: 6px; text-align: center; }
</style>
</head>
<body>

<div class="card">
  <h2 id="title"></h2>
  <p>ğŸ’° æ‰€æŒé‡‘: <span id="balance"></span> Ncoin</p>

  <h3>ğŸ’¸ æ‰‹å‹•é€é‡‘</h3>
  <input id="toUser" placeholder="é€é‡‘ç›¸æ‰‹ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
  <input id="amount" type="number" placeholder="é€é‡‘é¡" min="1">
  <button id="sendBtn">é€é‡‘ã™ã‚‹</button>
  <div id="sendResult" style="margin-top:10px; color:#007bff;"></div>
</div>

<div class="card">
  <h3>ğŸ“œ é€é‡‘å±¥æ­´</h3>
  <table>
    <thead><tr><th>æ—¥ä»˜</th><th>ç›¸æ‰‹</th><th>é‡‘é¡</th><th>ç¨®é¡</th></tr></thead>
    <tbody id="historyBody"></tbody>
  </table>
</div>

<div class="card">
  <h3>ğŸ† å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
  <table>
    <thead><tr><th>é †ä½</th><th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th><th>æ‰€æŒé‡‘</th></tr></thead>
    <tbody id="rankingBody"></tbody>
  </table>
</div>

<div class="card">
  <h3>ğŸ“± è‡ªåˆ†ã®QRã‚³ãƒ¼ãƒ‰</h3>
  <button id="qrBtn">QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º</button>
  <img id="qr" alt="QRã‚³ãƒ¼ãƒ‰">
</div>

<button class="logout" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

<script>
const nickname = localStorage.getItem("nickname");
if(!nickname){ window.location.href="/"; }

document.getElementById("title").textContent = nickname + " ã•ã‚“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰";

// åˆæœŸæ‰€æŒé‡‘è¨­å®š
let players = JSON.parse(localStorage.getItem("players")||"{}");
if(!(nickname in players)) players[nickname]=1000;

// å±¥æ­´
let sendHistory = JSON.parse(localStorage.getItem("sendHistory")||"[]");

// --- æ‰€æŒé‡‘æ›´æ–°é–¢æ•° ---
function updateBalances(){
  // ãƒªã‚»ãƒƒãƒˆå…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ®‹é«˜
  for(let p in players){
    players[p] = players[p]; // æ—¢å­˜å€¤ä¿æŒ
  }
  // å±¥æ­´åæ˜ 
  sendHistory.forEach(h=>{
    if(h.from in players) players[h.from]-=Number(h.amount);
    if(h.to in players) players[h.to]+=Number(h.amount);
    else players[h.to]=Number(h.amount);
  });
  localStorage.setItem("players",JSON.stringify(players));
  document.getElementById("balance").textContent = players[nickname];
}

// --- é€é‡‘å‡¦ç† ---
document.getElementById("sendBtn").addEventListener("click",()=>{
  const toUser = document.getElementById("toUser").value.trim();
  const amount = Number(document.getElementById("amount").value.trim());
  const resultEl = document.getElementById("sendResult");

  if(!toUser || !amount){ resultEl.style.color="red"; resultEl.textContent="ç›¸æ‰‹ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
  if(amount>players[nickname]){ resultEl.style.color="red"; resultEl.textContent="æ‰€æŒé‡‘ä¸è¶³ã§ã™"; return; }

  // å±¥æ­´ã«è¿½åŠ 
  sendHistory.push({from:nickname,to:toUser,amount,date:new Date().toLocaleString()});
  localStorage.setItem("sendHistory",JSON.stringify(sendHistory));

  // ç›¸æ‰‹ãŒæœªç™»éŒ²ãªã‚‰åˆæœŸæ‰€æŒé‡‘1000
  if(!(toUser in players)) players[toUser]=1000;
  localStorage.setItem("players",JSON.stringify(players));

  resultEl.style.color="#007bff";
  resultEl.textContent = `âœ… ${toUser} ã•ã‚“ã« ${amount} Ncoin é€é‡‘ã—ã¾ã—ãŸ`;

  updateBalances();
  renderHistory();
  renderRanking();
});

// --- é€é‡‘å±¥æ­´è¡¨ç¤º ---
function renderHistory(){
  const tbody = document.getElementById("historyBody");
  tbody.innerHTML="";
  const reversed = [...sendHistory].reverse();
  reversed.forEach(h=>{
    let type = h.from===nickname?"é€ä¿¡":"å—ä¿¡";
    let other = h.from===nickname?h.to:h.from;
    let tr = `<tr><td>${h.date}</td><td>${other}</td><td>${h.amount}</td><td>${type}</td></tr>`;
    tbody.innerHTML+=tr;
  });
}

// --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º ---
function renderRanking(){
  const tbody = document.getElementById("rankingBody");
  tbody.innerHTML="";
  const arr = Object.entries(players).sort((a,b)=>b[1]-a[1]);
  arr.forEach(([name,balance],idx)=>{
    let tr = `<tr><td>${idx+1}</td><td>${name}</td><td>${balance}</td></tr>`;
    tbody.innerHTML+=tr;
  });
}

// --- åˆæœŸè¡¨ç¤º ---
updateBalances();
renderHistory();
renderRanking();

// --- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ ---
document.getElementById("qrBtn").addEventListener("click", async()=>{
  const res = await fetch("/api/qrcode",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname})});
  const data = await res.json();
  if(data.qr){const img=document.getElementById("qr"); img.src=data.qr; img.style.display="block"; }
  else alert(data.error||"QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆå¤±æ•—");
});

// --- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ---
document.getElementById("logoutBtn").addEventListener("click",()=>{
  localStorage.removeItem("nickname");
  window.location.href="/";
});
</script>

</body>
</html>
